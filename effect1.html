<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>물총 이펙트 테스트</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #6b7b8d;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px 160px;
            overflow: hidden;
            user-select: none;
        }

        .building {
            background: #7e8e9e;
            padding: 22px;
            border-radius: 6px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.45);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 90px);
            gap: 14px;
        }

        .window {
            width: 90px;
            height: 90px;
            background: rgba(173, 216, 240, 0.65);
            border: 5px solid #8B6914;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            box-shadow: inset 0 0 12px rgba(0, 80, 160, 0.18);
            transition: background 0.1s;
        }
        .window:hover { background: rgba(173, 216, 240, 0.85); }

        .window::before {
            content: '';
            position: absolute;
            top: 50%; left: -5px; right: -5px;
            height: 4px;
            background: #8B6914;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 1;
        }
        .window::after {
            content: '';
            position: absolute;
            left: 50%; top: -5px; bottom: -5px;
            width: 4px;
            background: #8B6914;
            transform: translateX(-50%);
            pointer-events: none;
            z-index: 1;
        }

        /* ── 물총 (측면 뷰) ── */
        .gun-wrap {
            position: fixed;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
        }

        /* 총 전체 - 측면 뷰, 오른쪽 방향이 기본 */
        .gun {
            position: relative;
            width: 100px;
            height: 58px;
            transform-origin: center center;
            transition: transform 0.08s ease-out;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
        }

        /* 물탱크 - 배럴 위에 얹힘 */
        .gun-tank {
            position: absolute;
            top: 2px;
            left: 8px;
            width: 42px;
            height: 14px;
            background: rgba(100, 200, 255, 0.55);
            border: 2px solid #0288D1;
            border-radius: 7px;
        }

        /* 배럴 */
        .gun-barrel {
            position: absolute;
            top: 16px;
            left: 0;
            width: 70px;
            height: 18px;
            background: linear-gradient(to bottom, #29B6F6 30%, #0277BD 70%);
            border-radius: 4px 0 0 4px;
            border: 1.5px solid #01579B;
        }

        /* 총구 - 배럴 오른쪽 끝 */
        .gun-muzzle {
            position: absolute;
            top: 19px;
            right: 0;
            width: 16px;
            height: 12px;
            background: #01579B;
            border-radius: 0 5px 5px 0;
            border-left: 2px solid #003c6b;
        }

        /* 손잡이 - 배럴 아래 */
        .gun-grip {
            position: absolute;
            top: 34px;
            left: 22px;
            width: 14px;
            height: 22px;
            background: #01579B;
            border-radius: 0 0 6px 6px;
            border: 1px solid #003c6b;
        }

        /* 총구 끝 마커 - 위치 계산용, 보이지 않음 */
        .muzzle-point {
            position: absolute;
            top: 25px;   /* 총구 수직 중앙: 19 + 12/2 = 25 */
            right: 0px;  /* 총구 오른쪽 끝 */
            width: 1px;
            height: 1px;
            pointer-events: none;
        }

        /* ── 물줄기 ── */
        .water-stream {
            position: fixed;
            width: 8px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 45;
            transform-origin: bottom center;
        }
    </style>
</head>
<body>

<div class="building">
    <div class="grid" id="grid"></div>
</div>

<div class="gun-wrap">
    <div class="gun" id="gun">
        <div class="gun-tank"></div>
        <div class="gun-barrel"></div>
        <div class="gun-muzzle"></div>
        <div class="gun-grip"></div>
        <div class="muzzle-point" id="muzzlePoint"></div>
    </div>
</div>

<script>
    const grid        = document.getElementById('grid');
    const gun         = document.getElementById('gun');
    const muzzlePt    = document.getElementById('muzzlePoint');
    let shooting      = false;

    // 창문 16개 생성
    for (let i = 0; i < 16; i++) {
        const w = document.createElement('div');
        w.className = 'window';
        w.addEventListener('click', () => shoot(w));
        grid.appendChild(w);
    }

    function shoot(winEl) {
        if (shooting) return;
        shooting = true;

        const wr = winEl.getBoundingClientRect();
        const tx = wr.left + wr.width  / 2;
        const ty = wr.top  + wr.height / 2;

        // 총 중심 (회전 기준점)
        const gr = gun.getBoundingClientRect();
        const cx = gr.left + gr.width  / 2;
        const cy = gr.top  + gr.height / 2;

        // 오른쪽이 0도인 각도로 총 회전 (측면 뷰 기준)
        const gunAng = Math.atan2(ty - cy, tx - cx) * (180 / Math.PI);
        gun.style.transform = `rotate(${gunAng}deg)`;

        // 렌더링 두 프레임 후 실제 총구 위치 가져오기 (변환 완료 보장)
        requestAnimationFrame(() => requestAnimationFrame(() => {
            const mr = muzzlePt.getBoundingClientRect();
            const mx = mr.left + mr.width  / 2;
            const my = mr.top  + mr.height / 2;

            const dist = Math.hypot(tx - mx, ty - my);

            // 물줄기 방향: 총구 → 창문 (위쪽 기준 각도)
            const streamAng = Math.atan2(tx - mx, -(ty - my)) * (180 / Math.PI);

            // 물줄기 생성 (transform-origin: bottom center → bottom이 총구 위치)
            const stream = document.createElement('div');
            stream.className = 'water-stream';
            const bott = window.innerHeight - my;
            Object.assign(stream.style, {
                left:       `${mx - 4}px`,
                bottom:     `${bott}px`,
                height:     '0px',
                background: 'linear-gradient(to top, rgba(0,191,255,0.95), rgba(135,206,250,0.5))',
                transform:  `rotate(${streamAng}deg)`,
                transition: 'height 0.13s linear',
                boxShadow:  '0 0 6px rgba(0,191,255,0.6)',
            });
            document.body.appendChild(stream);

            requestAnimationFrame(() => requestAnimationFrame(() => {
                stream.style.height = `${dist}px`;
            }));

            // 창문 도달 → splash + 물줄기 사라짐
            setTimeout(() => {
                splash(tx, ty);

                stream.style.transition = 'opacity 0.12s';
                stream.style.opacity    = '0';
                setTimeout(() => stream.remove(), 150);

                setTimeout(() => {
                    gun.style.transform = '';
                    shooting = false;
                }, 400);
            }, 145);
        }));
    }

    // 물방울 터지는 이펙트만
    function splash(cx, cy) {
        const count = 12;
        for (let i = 0; i < count; i++) {
            const sz   = 4 + Math.random() * 9;
            const drop = document.createElement('div');
            Object.assign(drop.style, {
                position:      'fixed',
                width:         `${sz}px`,
                height:        `${sz}px`,
                background:    `rgba(${20 + Math.random()*40 | 0}, ${160 + Math.random()*70 | 0}, 255, 0.88)`,
                borderRadius:  '50%',
                left:          `${cx - sz / 2}px`,
                top:           `${cy - sz / 2}px`,
                pointerEvents: 'none',
                zIndex:        '100',
            });
            document.body.appendChild(drop);

            const a = (i / count) * Math.PI * 2 + Math.random() * 0.4;
            const r = 16 + Math.random() * 40;
            drop.animate([
                { transform: 'translate(0,0) scale(1)', opacity: 1 },
                { transform: `translate(${Math.cos(a)*r}px, ${Math.sin(a)*r}px) scale(0)`, opacity: 0 }
            ], {
                duration: 280 + Math.random() * 220,
                easing:   'ease-out',
                fill:     'forwards',
            }).onfinish = () => drop.remove();
        }
    }
</script>
</body>
</html>
